name: Freqtrade Dry-Run Test

on:
  workflow_dispatch:          # شغله يدوي من Actions tab

jobs:
  test-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Freqtrade (بدون TA-Lib إجباري في البداية)
        run: |
          pip install --upgrade pip
          pip install freqtrade[all] --no-cache-dir

      - name: Create user_data structure
        run: |
          mkdir -p user_data/strategies

          # إنشاء config بسيط وكامل
          cat > user_data/config.json << 'EOF'
          {
              "max_open_trades": 3,
              "stake_currency": "USDT",
              "stake_amount": "unlimited",
              "tradable_balance_ratio": 0.99,
              "dry_run": true,
              "dry_run_wallet": 1000,
              "timeframe": "5m",
              "exchange": {
                  "name": "binance",
                  "pair_whitelist": ["BTC/USDT", "ETH/USDT", "SOL/USDT"]
              },
              "telegram": {
                  "enabled": true,
                  "token": "8575558875:AAEK-jcmG5NF1NJGKdq3XHZ4XPcZxjvbtNo",
                  "chat_id": "978554149"
              }
          }
          EOF

          # إنشاء استراتيجية بسيطة جدًا (تفتح صفقات دايماً عشان نختبر)
          cat > user_data/strategies/TestAlwaysBuy.py << 'EOF'
          from freqtrade.strategy import IStrategy
          from pandas import DataFrame

          class TestAlwaysBuy(IStrategy):
              INTERFACE_VERSION = 3
              minimal_roi = {"0": 0.05}
              stoploss = -0.10
              timeframe = '5m'

              def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
                  return dataframe

              def populate_entry_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
                  dataframe['enter_long'] = 1
                  return dataframe

              def populate_exit_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
                  dataframe['exit_long'] = 0  # خروج فقط بالـ ROI أو stoploss
                  return dataframe
          EOF

      - name: Run Freqtrade dry-run
        run: |
          freqtrade trade \
            --config user_data/config.json \
            --strategy TestAlwaysBuy \
            --userdir user_data \
            --dry-run \
            --logfile user_data/freqtrade.log
