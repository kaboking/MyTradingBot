from freqtrade.strategy import IStrategy
from pandas import DataFrame
import pandas_ta as ta   # مهم: لازم تكون مثبت pandas_ta

class SampleStrategy(IStrategy):
    """
    استراتيجية اختبار بسيطة جدًا (EMA crossover + RSI فلتر)
    هدفه: تتأكد إن البوت يفتح ويخرج صفقات في dry-run
    """

    INTERFACE_VERSION = 3

    # ------------------ إعدادات أساسية ------------------
    timeframe = '5m'
    minimal_roi = {
        "60": 0.03,    # بعد 60 دقيقة: 3% ربح → خروج
        "30": 0.02,
        "0":  0.015
    }
    stoploss = -0.08       # خروج بخسارة 8%
    trailing_stop = False

    # ------------------ المؤشرات ------------------
    def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
        # EMA سريع وبطيء
        dataframe['ema_fast'] = ta.ema(dataframe['close'], length=9)
        dataframe['ema_slow'] = ta.ema(dataframe['close'], length=21)
        
        # RSI عشان فلتر (مش نشتري لو السوق overbought)
        dataframe['rsi'] = ta.rsi(dataframe['close'], length=14)
        
        return dataframe

    # ------------------ شروط الدخول (شراء) ------------------
    def populate_entry_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
        dataframe.loc[
            (
                (dataframe['ema_fast'] > dataframe['ema_slow']) &           # EMA crossover صاعد
                (dataframe['ema_fast'].shift(1) <= dataframe['ema_slow'].shift(1)) &  # عبر لفوق دلوقتي
                (dataframe['rsi'] < 70) &                                   # مش overbought
                (dataframe['volume'] > 0)
            ),
            ['enter_long', 'enter_tag']
        ] = (1, 'ema_cross_up')

        return dataframe

    # ------------------ شروط الخروج (بيع) ------------------
    def populate_exit_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
        dataframe.loc[
            (
                (dataframe['ema_fast'] < dataframe['ema_slow']) &           # EMA crossover هابط
                (dataframe['ema_fast'].shift(1) >= dataframe['ema_slow'].shift(1)) &
                (dataframe['rsi'] > 30)                                     # مش oversold جدًا
            ),
            ['exit_long', 'exit_tag']
        ] = (1, 'ema_cross_down')

        return dataframe
